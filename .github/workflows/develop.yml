name: Deploy to EC2 on Develop PR Merge

on:
  pull_request:
    types: [closed]
    branches:
      - develop

jobs:
  deploy:
    name: Deploy to EC2 (on develop PR merge)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}         # üîß EC2 ÌçºÎ∏îÎ¶≠ IP
          username: ${{ secrets.EC2_USER }}     # üîß ec2-user (Amazon Linux) ÎòêÎäî ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}       # üîß .pem ÌÇ§ ÌååÏùº ÎÇ¥Ïö©

          script: |
            # ÌïÑÏàò Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò
            if ! command -v git &> /dev/null; then
              sudo yum install -y git
            fi

            if ! command -v docker &> /dev/null; then
              sudo yum install -y docker
              sudo service docker start
              sudo usermod -aG docker $USER
            fi

            if ! command -v docker-compose &> /dev/null; then
              sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi

            # ÌîÑÎ°úÏ†ùÌä∏ Ï§ÄÎπÑ
            cd /home/ec2-user
            if [ ! -d "1-sprint-mission" ]; then
              git clone https://github.com/normaldeve/1-sprint-mission.git
            fi

            cd 1-sprint-mission
            git fetch origin
            git checkout develop
            git pull origin develop

            # docker compose Î∞∞Ìè¨
            docker compose --env-file discodeit.env down || true
            docker compose --env-file discodeit.env up -d --build